# HAProxy 配置 - 双证书模式测试
#
# 单前端 8443，根据路径分发到使用不同证书的后端：
# - gRPC 路径 → gRPC 后端 (50051) 使用 ligproxy-test.0ldm0s.net 证书
# - 其他路径 → HTTP 后端 (3001) 使用 ligproxy-http.0ldm0s.net 证书

global
    log stdout local0

defaults
    log global
    mode http
    timeout connect 5s
    timeout client  30s
    timeout server 30s
    option httplog
    option dontlognull

# 统计页面
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /
    stats refresh 10s

# HTTPS 前端（统一入口）
frontend main_front
    mode http
    bind *:8443 ssl crt /home/oldmos/workspaces/rust/rat_engine/examples/certs/ligproxy-test.0ldm0s.net-combined.pem alpn h2,http/1.1

    # gRPC 路径检测
    acl is_grpc_path path_beg /hello. /ping. /chat. /stock. /upload.

    # 根据路径分发
    use_backend grpc_backend if is_grpc_path
    default_backend http_backend

# gRPC 后端（50051）
backend grpc_backend
    mode http
    server grpc1 127.0.0.1:50051 ssl alpn h2 verify none sni str(ligproxy-test.0ldm0s.net)

# HTTP 后端（3001）- 使用 ligproxy-http.0ldm0s.net 证书
backend http_backend
    mode http
    server http1 127.0.0.1:3001 ssl alpn h2,http/1.1 verify none sni str(ligproxy-http.0ldm0s.net)
