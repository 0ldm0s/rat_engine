# HAProxy 配置 - HTTP + gRPC 混合代理测试
#
# 功能：
# - HTTP:  客户端 → HAProxy:8080  → HTTP:9090
# - gRPC:  客户端 → HAProxy:8443  → gRPC:50051 (TLS)

global
    log stdout local0

defaults
    log global
    mode http
    timeout connect 5s
    timeout client  30s
    timeout server 30s
    option httplog
    option dontlognull

# 统计页面
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /
    stats refresh 10s

# HTTPS 前端
frontend grpc_front
    mode http
    bind *:8443 ssl crt /home/oldmos/workspaces/rust/rat_engine/examples/certs/ligproxy-test.0ldm0s.net-combined.pem alpn h2,http/1.1
    default_backend grpc_backend

# gRPC 后端
# Xray-core 模式：HAProxy 与后端使用标准 gRPC（ALPN h2）
backend grpc_backend
    mode http
    server grpc1 127.0.0.1:50051 ssl alpn h2 verify none sni str(ligproxy-test.0ldm0s.net)

# HTTP 前端
frontend http_front
    mode http
    bind *:8080
    default_backend http_backend

# HTTP 后端（无 TLS）
backend http_backend
    mode http
    server http1 127.0.0.1:9090
