# HAProxy 配置 - TcpData 测试专用
#
# 模拟真实场景：单端口 8443，根据路径分发：
# - /test.ProxyService/* → TcpData 测试 gRPC 后端 (50051)
# - /lurker.LurkerService/* → Lurker gRPC 后端 (可选)
# - 其他路径 → 默认 HTTP 后端 (模拟其他服务)
#
# 这个配置用于测试双向流经过 HAProxy 后 TcpData 丢失问题

global
    log stdout local0
    daemon

defaults
    log global
    mode http
    timeout connect 5s
    timeout client  60s
    timeout server  60s
    option httplog
    option dontlognull

    # HTTP/2 相关设置
    option http-use-htx
    http-reuse always

# 统计页面
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /
    stats refresh 10s
    stats show-legends
    stats show-node

# HTTPS 前端（统一入口）
frontend main_front
    mode http
    bind *:8443 ssl crt /home/oldmos/workspaces/rust/rurker/certs/ligproxy-test.0ldm0s.net-combined.pem alpn h2,http/1.1

    # TCP/HTTP 检测日志
    http-request set-log-level debug

    # gRPC 服务路径 ACL 判断
    acl is_test_proxy_path path_beg /test.ProxyService
    acl is_lurker_path path_beg /lurker.LurkerService
    acl is_chat_path path_beg /chat.ChatService

    # 根据 ACL 分发到不同后端
    use_backend test_proxy_backend if is_test_proxy_path
    use_backend lurker_backend if is_lurker_path
    use_backend chat_backend if is_chat_path

    # 默认后端（模拟真实场景：其他 HTTP 服务）
    default_backend http_backend

# TcpData 测试专用后端 (50051)
# 这是我们的测试服务端
backend test_proxy_backend
    mode http
    server test_grpc 127.0.0.1:50051 ssl alpn h2 verify none sni str(ligproxy-test.0ldm0s.net)

# Lurker 服务后端（可选，用于对比）
backend lurker_backend
    mode http
    server lurker_grpc 127.0.0.1:50052 ssl alpn h2 verify none sni str(ligproxy-test.0ldm0s.net)

# Chat 服务后端（用于双向流对比测试）
backend chat_backend
    mode http
    server chat_grpc 127.0.0.1:50053 ssl alpn h2 verify none sni str(ligproxy-test.0ldm0s.net)

# 默认 HTTP 后端（模拟其他服务，无需实际运行）
backend http_backend
    mode http
    server http1 127.0.0.1:3001
